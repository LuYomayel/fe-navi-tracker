name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            echo "🚀 Iniciando deployment de NaviTracker..."

            # Navegar al directorio del proyecto
            cd ${{ secrets.PROJECT_PATH || '/home/fe-navi-tracker' }}

            # Verificar que estamos en el directorio correcto
            if [ ! -f "package.json" ]; then
              echo "❌ Error: No se encontró package.json en el directorio actual"
              echo "📁 Directorio actual: $(pwd)"
              echo "📂 Contenido del directorio:"
              ls -la
              exit 1
            fi

            echo "📁 Directorio actual: $(pwd)"

            # Verificar versión de Node.js
            echo "🔍 Verificando versión de Node.js..."
            node --version

            # Actualizar Node.js si es necesario (usando nvm)
            if command -v nvm &> /dev/null; then
              echo "📦 Actualizando Node.js con nvm..."
              export NVM_DIR="$HOME/.nvm"
              [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
              [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
              
              # Instalar y usar Node.js 20 LTS
              nvm install 20
              nvm use 20
              nvm alias default 20
              
              echo "✅ Node.js actualizado a: $(node --version)"
            else
              echo "⚠️  nvm no está disponible. Versión actual de Node.js: $(node --version)"
              echo "⚠️  Se requiere Node.js >= 18.18.0 para las dependencias"
            fi

            # Hacer backup de la versión actual
            echo "💾 Creando backup..."
            if [ -d ".next" ]; then
              cp -r .next .next.backup.$(date +%Y%m%d-%H%M%S) || true
            fi
            if [ -d "node_modules" ]; then
              mv node_modules node_modules.backup.$(date +%Y%m%d-%H%M%S) || true
            fi

            # Git pull desde main
            echo "📥 Actualizando código desde Git..."
            git fetch origin
            git reset --hard origin/main
            git pull origin main

            # Limpiar cache de npm
            echo "🧹 Limpiando cache de npm..."
            npm cache clean --force || true

            # Verificar Node.js antes de instalar
            echo "🔍 Verificando Node.js final: $(node --version)"
            echo "🔍 Verificando npm: $(npm --version)"

            # Instalar dependencias con configuración para ignorar engine warnings
            echo "📦 Instalando dependencias..."
            npm install --production=false --legacy-peer-deps --engine-strict=false

            # Verificar instalación
            echo "🔍 Verificando instalación..."
            if [ ! -d "node_modules" ]; then
              echo "❌ Error: node_modules no fue creado"
              echo "🔍 Intentando instalación alternativa..."
              npm install --force --production=false
              
              if [ ! -d "node_modules" ]; then
                echo "❌ Error: Falló la instalación de dependencias"
                exit 1
              fi
            fi

            # Build del proyecto
            echo "🔨 Construyendo proyecto..."
            npm run build

            # Verificar que el build fue exitoso
            if [ ! -d ".next" ]; then
              echo "❌ Error: Build falló - no se encontró directorio .next"
              exit 1
            fi

            echo "✅ Build completado exitosamente"

            # Reiniciar PM2 (navi-tracker-frontend)
            echo "🔄 Reiniciando PM2..."
            if pm2 list | grep -q "navi-tracker-frontend"; then
              pm2 restart navi-tracker-frontend
            else
              pm2 restart 5 || pm2 start .next/standalone/server.js --name "navi-tracker-frontend"
            fi

            # Verificar estado de PM2
            pm2 status

            # Reiniciar Apache2
            echo "🔄 Reiniciando Apache2..."
            sudo systemctl restart apache2

            # Verificar estado de Apache2
            sudo systemctl status apache2 --no-pager -l

            # Verificar que la aplicación esté respondiendo
            echo "🔍 Verificando que la aplicación esté funcionando..."
            sleep 10

            # Test de conectividad local
            if curl -f http://localhost:3150 > /dev/null 2>&1; then
              echo "✅ Aplicación respondiendo en puerto 3150"
            else
              echo "⚠️  Aplicación no responde en puerto 3150, verificando PM2..."
              pm2 logs navi-tracker-frontend --lines 20 || pm2 logs --lines 20
            fi

            # Limpiar cache de Next.js si es necesario
            echo "🧹 Limpiando cache..."
            rm -rf .next/cache/* || true

            # Limpiar backups antiguos (más de 3 días)
            echo "🧹 Limpiando backups antiguos..."
            find . -maxdepth 1 -name "*.backup.*" -mtime +3 -delete || true

            echo "🎉 Deployment completado exitosamente!"
            echo "📊 Estado final:"
            echo "- Node.js: $(node --version)"
            echo "- npm: $(npm --version)"
            echo "- PM2: $(pm2 list | grep navi-tracker-frontend || echo 'Proceso no encontrado con nombre navi-tracker-frontend')"
            echo "- Apache2: $(sudo systemctl is-active apache2)"
            echo "- Espacio en disco: $(df -h . | tail -1 | awk '{print $4}' | sed 's/G/ GB disponibles/')"
            echo "- Build ID: $(cat .next/BUILD_ID 2>/dev/null || echo 'No disponible')"

            # Notificar en logs
            echo "$(date): Deployment exitoso desde commit $(git rev-parse --short HEAD)" >> deployment.log
